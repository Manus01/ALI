rules_version = '2';

// =============================================================================
// Firebase Storage Security Rules - ALI Platform
// Version: 1.0 (Phase 0: Brand DNA Engine)
// =============================================================================

service firebase.storage {
  match /b/{bucket}/o {
    
    // -------------------------------------------------------------------------
    // HELPER FUNCTIONS
    // -------------------------------------------------------------------------
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidSize(maxSizeBytes) {
      return request.resource.size <= maxSizeBytes;
    }
    
    function hasContentType(allowedTypes) {
      return request.resource.contentType in allowedTypes;
    }
    
    // -------------------------------------------------------------------------
    // BRAND ASSETS (Phase 0: Brand DNA Engine)
    // Path: brand/{userId}/...
    // -------------------------------------------------------------------------
    
    match /brand/{userId}/{document=**} {
      // Only owners can read their brand assets
      allow read: if isOwner(userId);
      
      // Write with content type and size validation
      allow write: if isOwner(userId)
        && (
          // PDF Brand Guidelines - max 10MB
          (hasContentType(['application/pdf']) && isValidSize(10 * 1024 * 1024))
          // SVG Brand Patterns - max 1MB
          || (hasContentType(['image/svg+xml']) && isValidSize(1 * 1024 * 1024))
          // PNG/JPG Logos - max 5MB
          || (hasContentType(['image/png', 'image/jpeg']) && isValidSize(5 * 1024 * 1024))
        );
    }
    
    // -------------------------------------------------------------------------
    // ONBOARDING UPLOADS (Phase 0: Brand DNA Engine)
    // Path: onboarding/{userId}/...
    // -------------------------------------------------------------------------
    
    match /onboarding/{userId}/{document=**} {
      allow read: if isOwner(userId);
      
      allow write: if isOwner(userId)
        && (
          // PDF Brand Guidelines - max 10MB
          (hasContentType(['application/pdf']) && isValidSize(10 * 1024 * 1024))
          // SVG Patterns - max 1MB
          || (hasContentType(['image/svg+xml']) && isValidSize(1 * 1024 * 1024))
          // Images - max 5MB
          || (hasContentType(['image/png', 'image/jpeg', 'image/webp']) && isValidSize(5 * 1024 * 1024))
        );
    }
    
    // -------------------------------------------------------------------------
    // USER FILES (General user storage)
    // Path: users/{userId}/...
    // -------------------------------------------------------------------------
    
    match /users/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // -------------------------------------------------------------------------
    // CAMPAIGN ASSETS
    // Path: campaigns/{userId}/...
    // -------------------------------------------------------------------------
    
    match /campaigns/{userId}/{document=**} {
      allow read: if isOwner(userId);
      
      allow write: if isOwner(userId)
        && (
          // Images - max 10MB
          (hasContentType(['image/png', 'image/jpeg', 'image/webp', 'image/gif']) && isValidSize(10 * 1024 * 1024))
          // Videos - max 100MB
          || (hasContentType(['video/mp4', 'video/webm']) && isValidSize(100 * 1024 * 1024))
        );
    }
    
    // -------------------------------------------------------------------------
    // TUTORIAL ASSETS (Shared resources)
    // Path: tutorials/{tutorialId}/...
    // -------------------------------------------------------------------------
    
    match /tutorials/{tutorialId}/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Backend service account only
    }
    
    // -------------------------------------------------------------------------
    // TEMP UPLOADS (Processing)
    // Path: temp/{userId}/...
    // -------------------------------------------------------------------------
    
    match /temp/{userId}/{document=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidSize(50 * 1024 * 1024);
    }
    
    // -------------------------------------------------------------------------
    // PUBLIC ASSETS (Read-only)
    // Path: public/...
    // -------------------------------------------------------------------------
    
    match /public/{document=**} {
      allow read: if true;
      allow write: if false;
    }
    
  }
}
